{
    "Description": "This template deploys a simple VPC for egress testing",
    "Metadata": {
        "AWS::CloudFormation::Interface" : {
            "ParameterGroups" : [
                {
                "Parameters" : ["EnvironmentName","BIGIPType","ExistingKeyPairName" ]
                }
            ]
        }
    },
    "Parameters": {
        "BIGIPType": {
            "Type": "String",
            "Description": "PAYG requires acceptance of terms and subscription. https://aws.amazon.com/marketplace/server/procurement?productId=0d09bfd3-90c5-4b9c-98a2-c3860dbfcd9e",
            "Default": "Pay-As-You-Go",
            "AllowedValues": [
              "Pay-As-You-Go",
              "Bring-Your-Own-License"
            ]
        },
        "EnvironmentName":{
            "Description": "Name for your environment",
            "AllowedPattern": "[a-zA-Z]+$",
            "Type": "String"
        },
        "ExistingKeyPairName": {
          "Description": "Select an existing EC2 key pair to enable SSH access to the instance.",
          "Type": "AWS::EC2::KeyPair::KeyName",
          "AllowedPattern": "[a-zA-Z0-9-_~!@#$%^&*()\\+]+$",
          "ConstraintDescription": "You must select an existing EC2 key pair.",
          "Default": "Teller"
        },
        "Working": {
            "Type": "String",
            "Description": "Deploy everything needed for demo",
            "Default": "False",
            "AllowedValues": [
              "True",
              "False"
            ]
        }
    },
    "Conditions": {
        "False": {"Fn::Equals": [{"Ref": "BIGIPType"}, "True"]}
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.10.0.0/16",
                "EnableDnsSupport": true,
                "EnableDnsHostnames": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "VPC"
                                ]
                            ]
                        }
                    }
                ]
            },
            "DependsOn" : "IAMRoleKOPS"
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "IGW"
                                ]
                            ]
                        }
                    }
                ]
            },
            "DependsOn" : "IAMRoleKOPS"
        },
        "ElasticIPNatGW": {
            "Type" : "AWS::EC2::EIP",
            "Properties" : {
                "Domain" : "vpc"
            },
            "DependsOn" : "IAMRoleKOPS"
        },
        "ElasticIPBigIP02A": {
            "Type" : "AWS::EC2::EIP",
            "Properties" : {
                "Domain" : "vpc"
            },
            "DependsOn" : "IAMRoleKOPS"
        },
        "ElasticIPBigIP02B": {
            "Type" : "AWS::EC2::EIP",
            "Properties" : {
                "Domain" : "vpc"
            },
            "DependsOn" : "IAMRoleKOPS"
        },
        "AssociateElasticIPBigIP02A" : {
            "Type" : "AWS::EC2::EIPAssociation",
            "Properties" : {
                "AllocationId" : { "Fn::GetAtt" : [ "ElasticIPBigIP02A", "AllocationId" ]},
                "NetworkInterfaceId" : { "Ref" : "ENAPublicBigIP02" },
                "PrivateIpAddress": {"Fn::Select": [2, {"Fn::GetAtt": ["ENAPublicBigIP02", "SecondaryPrivateIpAddresses"]}]}
            }
        },
        "AssociateElasticIPBigIP02B" : {
            "Type" : "AWS::EC2::EIPAssociation",
            "Properties" : {
                "AllocationId" : { "Fn::GetAtt" : [ "ElasticIPBigIP02B", "AllocationId" ]},
                "NetworkInterfaceId" : { "Ref" : "ENAPublicBigIP02" },
                "PrivateIpAddress": {"Fn::Select": [3, {"Fn::GetAtt": ["ENAPublicBigIP02", "SecondaryPrivateIpAddresses"]}]}
            }
        },
        "NatGateway": {
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "AllocationId" : { "Fn::GetAtt" : ["ElasticIPNatGW", "AllocationId"]},
                "SubnetId" : { "Ref" : "PublicSubnet02AzA"},
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "NGW"
                                ]
                            ]
                        }
                    }
                ]
            },
            "DependsOn" : "IAMRoleKOPS"
        },
        "InternetGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "PublicRouteTable"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "PublicRouteDefault": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGatewayAttachment",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicSubnet01AzA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.10.1.0/24",
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "PublicSubnet01-AZ-A"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "PublicSubnet02AzA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.10.2.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "PublicSubnet02-AZ-A"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "PrivateSubnet01AzA": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                        0,
                        {
                            "Fn::GetAZs": ""
                        }
                    ]
                },
                "CidrBlock": "10.10.3.0/24",
                "MapPublicIpOnLaunch": false,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "PrivateSubnet01-AZ-A"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "PublicSubnet01AzARouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet01AzA"
                }
            }
        },
        "PublicSubnet02AzARouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "PublicSubnet02AzA"
                }
            }
        },
        "PrivateRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "PrivateRouteTable"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "PrivateRouteDefault": {
            "Type": "AWS::EC2::Route",
            "DependsOn" : "NatGateway",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                    "Ref": "NatGateway"
                }
            }
        },
        "PrivateSubnet01AzARouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PrivateRouteTable"
                },
                "SubnetId": {
                    "Ref": "PrivateSubnet01AzA"
                }
            }
        },
        "SSHSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "SecurityGroupIngress": [
                {
                    "IpProtocol": "6",
                    "FromPort" : 22,
                    "ToPort" : 22,
                    "CidrIp": "0.0.0.0/0",
                    "Description": "Allow SSH to JumpHost"
                }],
                "GroupDescription": "Allowed access to JumpHost",
                "VpcId": {
                  "Ref": "VPC"
                }
            }
        },
        "SecurityGroupSSH": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "SecurityGroupIngress": [
                {
                    "IpProtocol": "6",
                    "FromPort" : 22,
                    "ToPort" : 22,
                    "CidrIp": "0.0.0.0/0",
                    "Description": "Allow SSH"
                }],
                "GroupDescription": "Allowed SSH access",
                "VpcId": {
                  "Ref": "VPC"
              },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "SG",
                                    "SSH"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "bigip-k8s-nginx"
                    }
                ]
            }
        },
        "SecurityGroupHTTPS": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "SecurityGroupIngress": [
                {
                    "IpProtocol": "6",
                    "FromPort" : 443,
                    "ToPort" : 443,
                    "CidrIp": "0.0.0.0/0",
                    "Description": "Allow HTTPs"
                }],
                "GroupDescription": "Allowed HTTPs access",
                "VpcId": {
                  "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "SG",
                                    "HTTPs"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "bigip-k8s-nginx"
                    }
                ]
            }
        },
        "SecurityGroupPrivate": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "SecurityGroupIngress": [
                {
                    "IpProtocol": "-1",
                    "CidrIp": "10.10.0.0/16",
                    "Description": "Allow all traffic in private network"
                }],
                "GroupDescription": "Allow all traffic in private network",
                "VpcId": {
                  "Ref": "VPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "SG",
                                    "Private"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "bigip-k8s-nginx"
                    }
                ]
            }
        },
        "ENAPublicJumpHost01":{
            "Type": "AWS::EC2::NetworkInterface",
            "Properties": {
                "SourceDestCheck": false,
                "Description": "Public Interface for Jump Host",
                "GroupSet": [
                    {
                        "Ref": "SecurityGroupSSH"
                    }
                ],
                "PrivateIpAddress": "10.10.1.10",
                "SubnetId": {
                    "Ref": "PublicSubnet01AzA"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "JumpHost",
                                    "PublicENA",
                                    "01"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "ENAPrivateJumpHost01":{
            "Condition": "False",
            "Type": "AWS::EC2::NetworkInterface",
            "Properties": {
                "SourceDestCheck": false,
                "Description": "Private Interface for Jump Host",
                "GroupSet": [
                    {
                        "Ref": "SSHSecurityGroup"
                    }
                ],
                "PrivateIpAddress": "10.10.3.10",
                "SubnetId": {
                    "Ref": "PrivateSubnet01AzA"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "JumpHost",
                                    "PrivateENA",
                                    "01"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "ENAPublicBigIP01":{
            "Type": "AWS::EC2::NetworkInterface",
            "Properties": {
                "SourceDestCheck": false,
                "Description": "Mgmt Interface for BigIP",
                "GroupSet": [
                    {
                        "Ref": "SecurityGroupSSH"
                    },
                    {
                        "Ref": "SecurityGroupHTTPS"
                    }
                ],
                "PrivateIpAddress": "10.10.1.50",
                "SubnetId": {
                    "Ref": "PublicSubnet01AzA"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "BigIP",
                                    "PublicENA",
                                    "01"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "ENAPublicBigIP02":{
            "Type": "AWS::EC2::NetworkInterface",
            "Properties": {
                "SourceDestCheck": false,
                "Description": "External Interface for BigIP",
                "GroupSet": [
                    {
                        "Ref": "SSHSecurityGroup"
                    }
                ],
                "PrivateIpAddresses": [
                    {"PrivateIpAddress": "10.10.2.50", "Primary": true},
                    {"PrivateIpAddress": "10.10.2.51", "Primary": false},
                    {"PrivateIpAddress": "10.10.2.52", "Primary": false},
                    {"PrivateIpAddress": "10.10.2.60", "Primary": false},
                    {"PrivateIpAddress": "10.10.2.70", "Primary": false}
                ],
                "SubnetId": {
                    "Ref": "PublicSubnet02AzA"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "BigIP",
                                    "PublicENA",
                                    "02"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "ENAPrivateBigIP01":{
            "Type": "AWS::EC2::NetworkInterface",
            "Properties": {
                "SourceDestCheck": false,
                "Description": "Internal Interface for BigIP",
                "GroupSet": [
                    {
                        "Ref": "SecurityGroupPrivate"
                    }
                ],
                "PrivateIpAddresses": [
                    {"PrivateIpAddress": "10.10.3.50", "Primary": true},
                    {"PrivateIpAddress": "10.10.3.51", "Primary": false},
                    {"PrivateIpAddress": "10.10.3.52", "Primary": false}
                ],
                "SubnetId": {
                    "Ref": "PrivateSubnet01AzA"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "BigIP",
                                    "PrivateENA",
                                    "01"
                                ]
                            ]
                        }
                    }
                ]
            }
        },
        "EC2JumpHost": {
            "Condition": "False",
            "Type" : "AWS::EC2::Instance",
            "Properties": {
                "KeyName": {
                  "Ref": "ExistingKeyPairName"
                },
                "IamInstanceProfile" : {"Ref" : "InstanceProfile"},
                "NetworkInterfaces": [
                     {
                        "Description": "Public Interface",
                        "DeviceIndex": "0",
                        "NetworkInterfaceId":
                        {
                            "Ref": "ENAPublicJumpHost01"
                        }
                    }
                ],
                "InstanceType": "t3.medium",
                "ImageId": {
                  "Fn::FindInMap": [
                    "Ubuntu1804",
                    {
                      "Ref": "AWS::Region"
                    },
                    "AMI"
                  ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "JumpHost"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "bigip-k8s-nginx"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash\n",
                                "\n## Install required applications\n",
                                "sudo apt-get update\n",
                                "sudo apt-get install jq -y\n",
                                "sudo apt-get install awscli -y\n",
                                "\n### Install kops\n",
                                "curl -Lo kops https://github.com/kubernetes/kops/releases/download/$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | jq -r .tag_name )/kops-linux-amd64\n",
                                "\n### Install kubectl\n",
                                "curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl\n",
                                "\n### Move kubectl and kops binary\n",
                                "chmod +x ./kubectl ./kops\n",
                                "sudo mv ./kubectl ./kops /usr/local/bin/\n",
                                "\n### Start configuration based on environment\n",
                                { "Fn::Sub": [ "export KOPS_NAME=${StackName}.k8s.local\n", { "StackName": {"Ref" : "AWS::StackName" }} ]},
                                "echo export KOPS_NAME=$KOPS_NAME >> /etc/profile.d/88-all-profiles.sh\n",
                                { "Fn::Sub": [ "export KOPS_STATE_STORE=s3://${BucketName}\n", { "BucketName": {"Ref": "S3BucketKOPS"} }]},
                                "echo export KOPS_STATE_STORE=$KOPS_STATE_STORE >> /etc/profile.d/88-all-profiles.sh\n",
                                { "Fn::Sub": [ "export KOPS_VPC_ID=${vpcID}\n", { "vpcID": {"Ref": "VPC"} }]},
                                { "Fn::Sub": [ "export KOPS_SUBNET_ID=${SubnetID}\n", { "SubnetID": {"Ref": "PrivateSubnet01AzA"} }]},
                                { "Fn::Sub": [ "export KOPS_AVAIL_ZONES=${AZ}\n", { "AZ": {"Fn::GetAtt" : [ "PrivateSubnet01AzA" , "AvailabilityZone" ]} }]},
                                { "Fn::Sub": [ "export KOPS_SECURITY_GROUP=${SG}\n", {"SG": {"Ref" : "SecurityGroupPrivate"} }]},
                                "sudo -u ubuntu mkdir /home/ubuntu/bigip-nginx-k8s\n",
                                "sudo -u ubuntu git clone https://github.com/r-teller/bigip-nginx-k8s.git /home/ubuntu/bigip-nginx-k8s\n",
                                "sudo -u ubuntu kops create cluster \\\n",
                                    "\t--state=${KOPS_STATE_STORE} \\\n",
                                    "\t--cloud=aws \\\n",
                                    "\t--vpc=${KOPS_VPC_ID} \\\n",
                                    "\t--master-zones=${KOPS_AVAIL_ZONES} \\\n",
                                    "\t--master-security-groups=${KOPS_SECURITY_GROUP} \\\n",
                                    "\t--zones=${KOPS_AVAIL_ZONES} \\\n",
                                    "\t--subnets=${KOPS_SUBNET_ID} \\\n",
                                    "\t--utility-subnets=${KOPS_SUBNET_ID} \\\n",
                                    "\t--node-count=1 \\\n",
                                    "\t--topology=private \\\n",
                                    "\t--api-loadbalancer-type=internal \\\n",
                                    "\t--networking=kopeio-vxlan \\\n",
                                    "\t--node-size=t3.medium \\\n",
                                    "\t--node-security-groups=${KOPS_SECURITY_GROUP} \\\n",
                                    "\t--master-size=t3.medium \\\n",
                                    "\t--ssh-public-key=/home/ubuntu/.ssh/authorized_keys \\",
                                    "\t--name=${KOPS_NAME} --yes\n\n",
                                "\n### Store BIG-IP Creds as k8s secret\n",
                                { "Fn::Sub": [ "kubectl create secret generic bigip-login --namespace bigip-ingress --from-literal=username=BigIPk8s --from-literal=password=${BigIPk8s_PWD}\n", { "BigIPk8s_PWD": {"Ref": "EC2BigIPPAYG"} }]}
                            ]
                        ]
                    }
                }
            }
        },
        "EC2JumpHostV2": {
            "Type" : "AWS::EC2::Instance",
            "Metadata" : {
                "AWS::CloudFormation::Init" : {
                    "configSets" : {
                        "InstallAndConfigure" : [ "Install","Configure" ]
                    },
                    "Install" : {
                        "packages" : {
                            "yum" : {
                                "squid" : [],
                                "jq": [],
                                "git": []
                            }
                        },
                        "files": {
                            "/tmp/setup_host.sh": {
                                "group":  "root",
                                "mode":  "000755",
                                "owner":  "root",
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash -xe\n",
                                            "\n### Install kops\n",
                                            "curl -Lo kops https://github.com/kubernetes/kops/releases/download/$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | jq -r .tag_name )/kops-linux-amd64\n",
                                            "\n### Install kubectl\n",
                                            "curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl\n",
                                            "\n### Move kubectl and kops binary\n",
                                            "chmod +x ./kubectl ./kops\n",
                                            "mv ./kubectl ./kops /usr/bin/\n",
                                            "\n### git bigip-nginx-k8s repo\n",
                                            "mkdir /tmp/bigip-nginx-k8s\n",
                                            "git clone https://github.com/r-teller/bigip-nginx-k8s /tmp/bigip-nginx-k8s\n",
                                            "\n### Configure AWSCLI\n",
                                            { "Fn::Sub": [ "echo export AWS_REGION=${AWS_REGION} >>  /etc/profile.d/88-all-profiles.sh\n", { "AWS_REGION": {"Ref" : "AWS::Region" }} ]},
                                            { "Fn::Sub": [ "echo export AWS_VPC_ID=${AWS_VPC_ID} >>  /etc/profile.d/88-all-profiles.sh\n", { "AWS_VPC_ID": {"Ref" : "VPC" }} ]},
                                            { "Fn::Sub": [ "echo export AWS_STACK_NAME=${AWS_STACK_NAME} >>  /etc/profile.d/88-all-profiles.sh\n", { "AWS_STACK_NAME": {"Ref" : "AWS::StackName" }} ]},
                                            { "Fn::Sub": [ "echo export AWS_STACK_ENVIRONMENTNAME=${AWS_STACK_ENVIRONMENTNAME} >>  /etc/profile.d/88-all-profiles.sh\n", { "AWS_STACK_ENVIRONMENTNAME": {"Ref" : "EnvironmentName" }} ]},
                                            { "Fn::Sub": [ "echo export KOPS_NAME=${AWS_STACK_ENVIRONMENTNAME}.k8s.local >> /etc/profile.d/88-all-profiles.sh\n", { "AWS_STACK_ENVIRONMENTNAME": {"Ref" : "EnvironmentName" }} ]},
                                            { "Fn::Sub": [ "echo export KOPS_STATE_STORE=s3://${BucketName}  >> /etc/profile.d/88-all-profiles.sh\n", { "BucketName": {"Ref": "S3BucketKOPS"} }]},
                                            { "Fn::Sub": [ "sudo -u ec2-user aws configure set region ${AWS_REGION}\n", { "AWS_REGION": {"Ref" : "AWS::Region" }} ]}
                                        ]
                                    ]
                                }
                            },
                            "/tmp/provision_kops.sh": {
                                "group":  "root",
                                "mode":  "000755",
                                "owner":  "root",
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash -xe\n",
                                            "\n### Start configuration based on environment values\n",
                                            { "Fn::Sub": [ "export KOPS_VPC_ID=${vpcID}\n", { "vpcID": {"Ref": "VPC"} }]},
                                            { "Fn::Sub": [ "export KOPS_SUBNET_ID=${SubnetID}\n", { "SubnetID": {"Ref": "PrivateSubnet01AzA"} }]},
                                            { "Fn::Sub": [ "export KOPS_AVAIL_ZONES=${AZ}\n", { "AZ": {"Fn::GetAtt" : [ "PrivateSubnet01AzA" , "AvailabilityZone" ]} }]},
                                            { "Fn::Sub": [ "export KOPS_SECURITY_GROUP=${SG}\n", {"SG": {"Ref" : "SecurityGroupPrivate"} }]},
                                            { "Fn::Sub": [ "export KOPS_NAME=${AWS_STACK_ENVIRONMENTNAME}.k8s.local\n", { "AWS_STACK_ENVIRONMENTNAME": {"Ref" : "EnvironmentName" }} ]},
                                            { "Fn::Sub": [ "export KOPS_STATE_STORE=s3://${BucketName}\n", { "BucketName": {"Ref": "S3BucketKOPS"} }]},
                                            "kops create cluster \\\n",
                                                "\t--state=${KOPS_STATE_STORE} \\\n",
                                                "\t--cloud=aws \\\n",
                                                "\t--vpc=${KOPS_VPC_ID} \\\n",
                                                "\t--master-zones=${KOPS_AVAIL_ZONES} \\\n",
                                                "\t--master-security-groups=${KOPS_SECURITY_GROUP} \\\n",
                                                "\t--zones=${KOPS_AVAIL_ZONES} \\\n",
                                                "\t--subnets=${KOPS_SUBNET_ID} \\\n",
                                                "\t--utility-subnets=${KOPS_SUBNET_ID} \\\n",
                                                "\t--disable-subnet-tags \\\n",
                                                "\t--node-count=1 \\\n",
                                                "\t--topology=private \\\n",
                                                "\t--api-loadbalancer-type=internal \\\n",
                                                "\t--networking=amazon-vpc-routed-eni \\\n",
                                                "\t--node-size=t3.medium \\\n",
                                                "\t--node-security-groups=${KOPS_SECURITY_GROUP} \\\n",
                                                "\t--master-size=t3.medium \\\n",
                                                "\t--ssh-public-key=/home/ec2-user/.ssh/authorized_keys \\\n",
                                                "\t--name=${KOPS_NAME} --yes\n\n"
                                        ]
                                    ]
                                }
                            },
                            "/tmp/protect_stack.sh": {
                                "group":  "root",
                                "mode":  "000755",
                                "owner":  "root",
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash -xe\n\n",
                                            "### Protect stack from termination, to prevent orphaned k8s deployments\n",
                                            "### run /tmp/deprovision_stack.sh to delete the stack\n",
                                            { "Fn::Sub": [ "sudo -u ec2-user aws cloudformation update-termination-protection --enable-termination-protection --stack-name ${StackName}\n", { "StackName": {"Ref" : "AWS::StackName" }} ]}
                                        ]
                                    ]
                                }
                            },
                            "/tmp/deprovision_stack.sh": {
                                "group":  "root",
                                "mode":  "000755",
                                "owner":  "root",
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash -xe\n\n",
                                            "### Unprotects stack from termination\n",
                                            { "Fn::Sub": [ "aws cloudformation update-termination-protection --no-enable-termination-protection --stack-name ${StackName}\n", { "StackName": {"Ref" : "AWS::StackName" }} ]},
                                            "\n### Delets k8s cluster\n",
                                            "kops delete cluster \\\n",
                                                "\t--state=${KOPS_STATE_STORE} \\\n",
                                                "\t--name=${KOPS_NAME} --yes\n\n",
                                            "\n### Delets Stack\n",
                                            { "Fn::Sub": [ "aws cloudformation delete-stack --stack-name ${StackName} --region ${Region}\n", {
                                                        "StackName": {"Ref" : "AWS::StackName" },
                                                        "Region": {"Ref": "AWS::Region"}
                                                    }
                                                ]
                                            }
                                        ]
                                    ]
                                }
                            },
                            "/tmp/setup_k8s.sh": {
                                "group":  "root",
                                "mode":  "000755",
                                "owner":  "root",
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash -xe\n\n",
                                            "echo 'Waiting for k8s master node to be ready'\n",
                                            "date\n",
                                            "K8s_STATUS=`kubectl get nodes -l kubernetes.io/role=master -o json | jq '.items|length'`\n",
                                            "while [[ ${K8s_STATUS} -lt 1 ]]; do\n",
                                            "    sleep 5;\n",
                                            "    echo -n '.';\n",
                                            "    K8s_STATUS=`kubectl get nodes -l kubernetes.io/role=master -o json | jq '.items|length'`;\n",
                                            "done\n\n",
                                            "echo 'Waiting for k8s worker node to be ready'\n",
                                            "date\n",
                                            "K8s_STATUS=`kubectl get nodes -l kubernetes.io/role=node -o json | jq '.items|length'`\n",
                                            "while [[ ${K8s_STATUS} -lt 1 ]]; do\n",
                                            "    sleep 5;\n",
                                            "    echo -n '.';\n",
                                            "    K8s_STATUS=`kubectl get nodes -l kubernetes.io/role=node -o json | jq '.items|length'`;\n",
                                            "done\n\n",
                                            "date\n",
                                            "echo 'provisioning nginx-ingress'\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/1_1_nginx-ingress_ns-sa-cm.yaml\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/1_2_nginx-ingress_rbac.yaml\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/1_3_nginx-ingress_CustomResourceDefinition.yaml\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/1_4_nginx-ingress_DefaultSecrets.yaml\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/1_5_nginx-ingress_DaemonSet_A.yaml\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/1_6_nginx-ingress_Service_A.yaml\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/1_5_nginx-ingress_DaemonSet_B.yaml\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/1_6_nginx-ingress_Service_B.yaml\n",
                                            "date\n",
                                            "echo 'provisioning bigip-ingress'\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/2_1_bigip-ingress_ns.yaml\n",
                                            { "Fn::Sub": [ "kubectl create secret generic bigip-login --namespace bigip-ingress --from-literal=username=BigIPk8s --from-literal=password=${EC2BigIPPAYG}\n", { "EC2BigIPPAYG": {"Ref" : "EC2BigIPPAYG" }} ]},
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/2_2_bigip-ingress_rbac.yaml\n",
                                            "kubectl apply -f /tmp/bigip-nginx-k8s/1_scripts/yaml/2_3_bigip-ingress_Deployment.yaml\n"
                                        ]
                                    ]
                                }
                            }
                        }
                    },
                    "Configure": {
                        "commands": {
                            "01_setup_host": {
                                "command":  "/tmp/setup_host.sh  > /tmp/setup_host.log 2>&1  \n "
                            },
                            "02_protect_stack":{
                                "command": "sudo -u ec2-user /tmp/protect_stack.sh > /tmp/protect_stack.log 2>&1 \n"
                            },
                            "03_provision_kops": {
                                "command":  "sudo -u ec2-user /tmp/provision_kops.sh > /tmp/provision_kops.log 2>&1 \n "
                            },
                            "04_setup_k8s": {
                                "command":  "sudo -u ec2-user /tmp/setup_k8s.sh > /tmp/setup_k8s.log 2>&1 \n"
                            }
                        }
                    }
                }
            },
            "Properties": {
                "KeyName": {
                  "Ref": "ExistingKeyPairName"
                },
                "IamInstanceProfile" : {"Ref" : "InstanceProfile"},
                "NetworkInterfaces": [
                     {
                        "Description": "Public Interface",
                        "DeviceIndex": "0",
                        "NetworkInterfaceId":
                        {
                            "Ref": "ENAPublicJumpHost01"
                        }
                    }
                ],
                "InstanceType": "t3.medium",
                "ImageId": {
                  "Fn::FindInMap": [
                    "AWSLinux2",
                    {
                      "Ref": "AWS::Region"
                    },
                    "AMI"
                  ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "JumpHost"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "bigip-k8s-nginx"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash  -xe\n",
                                "\n## Update aws-cfn if required\n",
                                "yum update aws-cfn-bootstrap\n",
                                "\n## Install required applications\n",
                                { "Fn::Sub": [ "export STACK_ID=${stackID}\n", { "stackID": {"Ref": "AWS::StackId"} }]},
                                { "Fn::Sub": [ "export Region=${region}\n", { "region": {"Ref": "AWS::Region"} }]},
                                "echo cfn-init isntalling and configuring scripts\n",
                                "/opt/aws/apitools/cfn-init/bin/cfn-init -v \\\n",
                                "\t--configsets InstallAndConfigure \\\n",
                                "\t--stack ${STACK_ID} \\\n",
                                "\t--resource EC2JumpHostV2 \\\n",
                                "\t--region ${Region} \n"
                            ]
                        ]
                    }
                }
            }
        },
        "S3BucketKOPS":{
            "Type" : "AWS::S3::Bucket",
            "Properties": {
                "BucketName" : {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "kops-state"
                        ]
                    ]
                }
            },
            "DependsOn" : "IAMRoleKOPS"
        },
        "InstanceProfile" : {
            "Type" : "AWS::IAM::InstanceProfile",
            "Properties" : {
                "Path" : "/",
                "Roles" : [{"Ref": "IAMRoleKOPS"}]
            }
        },
        "IAMRoleKOPS" : {
          "Type" : "AWS::IAM::Role",
          "Properties" : {
                "RoleName" : {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "kops-iam-role"
                        ]
                    ]
                },
                "Path" : "/",
                "Policies": [ {
                    "PolicyName": "root",
                    "PolicyDocument": {
                        "Version" : "2012-10-17",
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Action": [
                                    "cloudformation:Get*",
                                    "cloudformation:DeleteStack",
                                    "cloudformation:UpdateTerminationProtection"
                                ],
                                "Resource": {
                                    "Ref": "AWS::StackId"
                                }
                            }, {
                                    "Effect": "Allow",
                                    "Action": "s3:*",
                                    "Resource": "*"
                            }, {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:*",
                                        "elasticloadbalancing:*",
                                        "autoscaling:*",
                                        "iam:*"
                                    ],
                                    "Resource": "*"
                            }
                        ]
                    }
                } ],
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "ec2.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }]
                }
            }
        },
        "EC2BigIPPAYG": {
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "config": {
                        "files": {
                            "/tmp/firstrun.utils": {
                                "group":  "root",
                                "mode":  "000755",
                                "owner":  "root",
                                "source":  "http://cdn.f5.com/product/templates/utils/firstrun.utils"
                            },
                            "/tmp/bigip_utils.sh": {
                                "group":  "root",
                                "mode":  "000755",
                                "owner":  "root",
                                "source":  "https://raw.githubusercontent.com/r-teller/bigip-nginx-k8s/master/1_scripts/shell/bigip_utils.sh"
                            },
                            "/tmp/firstrun.sh": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "#!/bin/bash\n",
                                            ". /tmp/firstrun.utils\n",
                                            "FILE=/tmp/firstrun.log\n",
                                            "if [ ! -e $FILE ]\n",
                                            " then\n",
                                            "     touch $FILE\n",
                                            "     nohup $0 0<&- &>/dev/null &\n",
                                            "     exit\n",
                                            "fi\n",
                                            "exec 1<&-\n",
                                            "exec 2<&-\n",
                                            "exec 1<>$FILE\n",
                                            "exec 2>&1\n",
                                            "date\n",
                                            "checkStatusnoret\n",
                                            "export Instance_ID=`curl http://169.254.169.254/latest/meta-data/instance-id`\n",
                                            "echo 'starting tmsh config'\n",
                                            "tmsh modify sys global-settings gui-setup disabled\n",
                                            "tmsh modify sys httpd auth-pam-validate-ip off\n",
                                            "tmsh modify auth password-policy policy-enforcement disabled\n",
                                            "tmsh modify auth user admin password ${Instance_ID}\n",
                                            "tmsh create auth user BigIPk8s partition-access add { all-partitions { role admin }} password ${Instance_ID}\n",
                                            "tmsh create auth partition nginx\n",
                                            "tmsh save /sys config\n",
                                            "date\n",
                                            "echo 'provisioning required modules'\n",
                                            "tmsh modify sys provision avr asm level nominal\n",
                                            "tmsh save /sys config\n",
                                            "checkStatusnoret\n",
                                            "echo 'configure self-ip'\n",
                                            "for mac in `curl http://169.254.169.254/latest/meta-data/network/interfaces/macs/` \n",
                                            "    do \n",
                                            "        device_number=`curl http://169.254.169.254/latest/meta-data/network/interfaces/macs/${mac:0:-1}/device-number` \n",
                                            "        case $device_number in \n",
                                            "        0) \n",
                                            "            ;; \n",
                                            "        1) \n",
                                            "            dev1_cdr=`curl http://169.254.169.254/latest/meta-data/network/interfaces/macs/${mac:0:-1}/subnet-ipv4-cidr-block` \n",
                                            "            dev1_pfx=${dev1_cdr#*/} \n",
                                            "            dev1_int=`tmsh list net interface one-line | grep -i ${mac:0:-1} | awk '{print $3}'` \n",
                                            "            ;; \n",
                                            "        2) \n",
                                            "            dev2_cdr=`curl http://169.254.169.254/latest/meta-data/network/interfaces/macs/${mac:0:-1}/subnet-ipv4-cidr-block` \n",
                                            "            dev2_pfx=${dev2_cdr#*/} \n",
                                            "            dev2_int=`tmsh list net interface one-line | grep -i ${mac:0:-1} | awk '{print $3}'` \n",
                                            "            ;;\n",
                                            "        esac \n",
                                            "    done\n",
                                            "tmsh create net vlan external interfaces add { ${dev1_int} { untagged} }\n",
                                            "tmsh create net vlan internal interfaces add { ${dev2_int} { untagged} }\n",
                                            { "Fn::Sub": [ "tmsh create net self ${Self_IP}", { "Self_IP": { "Fn::Select" : [1, {"Fn::GetAtt" : [ "ENAPublicBigIP02" , "SecondaryPrivateIpAddresses" ]} ] } }]}, "/${dev1_pfx}  vlan external allow-service none traffic-group traffic-group-local-only\n",
                                            { "Fn::Sub": [ "tmsh create net self ${Self_IP}", { "Self_IP": { "Fn::Select" : [0, {"Fn::GetAtt" : [ "ENAPublicBigIP02" , "SecondaryPrivateIpAddresses" ]} ] } }]}, "/${dev1_pfx}  vlan external allow-service none traffic-group traffic-group-1\n",
                                            { "Fn::Sub": [ "tmsh create net self ${Self_IP}", { "Self_IP": { "Fn::Select" : [1, {"Fn::GetAtt" : [ "ENAPrivateBigIP01" , "SecondaryPrivateIpAddresses" ]} ] } }]}, "/${dev2_pfx}  vlan internal allow-service default traffic-group traffic-group-local-only\n",
                                            { "Fn::Sub": [ "tmsh create net self ${Self_IP}", { "Self_IP": { "Fn::Select" : [0, {"Fn::GetAtt" : [ "ENAPrivateBigIP01" , "SecondaryPrivateIpAddresses" ]} ] } }]}, "/${dev2_pfx}  vlan internal allow-service default traffic-group traffic-group-1\n",
                                            "date\n",
                                            "echo 'create virtual-servers'\n",
                                            { "Fn::Sub": [
                                                "tmsh create ltm virtual k8s_vip_https destination ${Destination_IP}:443  profiles add { http {} clientssl { context clientside } } vlans add { external } source-address-translation { type automap }\n",
                                                { "Destination_IP": {
                                                    "Fn::Select" : [2, {"Fn::GetAtt" : [ "ENAPublicBigIP02" , "SecondaryPrivateIpAddresses" ]}]
                                                    } }]},
                                            "date\n",
                                            "# typically want to remove firstrun.config after first boot\n",
                                            "# rm /tmp/firstrun.config\n"
                                        ]
                                    ]
                                },
                                "group":  "root",
                                "mode":  "000755",
                                "owner":  "root"
                            }
                        },
                        "commands": {
                            "b-configure-Bigip": {
                                "command":  "/tmp/firstrun.sh\n "
                            }
                        }
                    }
                }
            },
            "Type" : "AWS::EC2::Instance",
            "Properties": {
                "KeyName": {
                  "Ref": "ExistingKeyPairName"
                },
                "NetworkInterfaces": [
                     {
                        "Description": "Public Interface",
                        "DeviceIndex": "0",
                        "NetworkInterfaceId":
                        {
                            "Ref": "ENAPublicBigIP01"
                        }
                    }
                ],
                "InstanceType": "t2.large",
                "ImageId": {
                  "Fn::FindInMap": [
                    "BigIPPAYG200Mb",
                    {
                      "Ref": "AWS::Region"
                    },
                    "AMI"
                  ]
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    "BigIP"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": "bigip-k8s-nginx"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash\n",
                                { "Fn::Sub": [ "export STACK_ID=${stackID}\n", { "stackID": {"Ref": "AWS::StackId"} }]},
                                { "Fn::Sub": [ "export Region=${region}\n", { "region": {"Ref": "AWS::Region"} }]},
                                "/opt/aws/apitools/cfn-init/bin/cfn-init -v \\\n",
                                "\t-s ${STACK_ID} \\\n",
                                "\t-r EC2BigIPPAYG \\\n",
                                "\t--region ${Region} \n"
                            ]
                        ]
                    }
                }
            }
        },
        "AttachENAPublicBigIP02": {
            "Type" : "AWS::EC2::NetworkInterfaceAttachment",
                "Properties" : {
                    "InstanceId" : {"Ref" : "EC2BigIPPAYG"},
                    "NetworkInterfaceId" : {"Ref" : "ENAPublicBigIP02"},
                    "DeviceIndex" : "1"
                }
        },
        "AttachENAPrivateBigIP01": {
            "Type" : "AWS::EC2::NetworkInterfaceAttachment",
                "Properties" : {
                    "InstanceId" : {"Ref" : "EC2BigIPPAYG"},
                    "NetworkInterfaceId" : {"Ref" : "ENAPrivateBigIP01"},
                    "DeviceIndex" : "2"
                }
        }
    },
    "Mappings": {
        "BigIPPAYG200Mb": {
            "eu-north-1" : {"AMI" : "ami-69df5717"},
            "ap-south-1" : {"AMI" : "ami-0dbdc3876b48aa8c6"},
            "eu-west-3" : {"AMI" : "ami-0ee53ccfe910eaa4c"},
            "eu-west-2" : {"AMI" : "ami-0f8d8e09823cb6e1d"},
            "eu-west-1" : {"AMI" : "ami-003f4d39ac196b31b"},
            "ap-northeast-2" : {"AMI" : "ami-01c83fd54619542a2"},
            "ap-northeast-1" : {"AMI" : "ami-056524dc31b358988"},
            "sa-east-1" : {"AMI" : "ami-0d29d40b6b0d01b72"},
            "ca-central-1" : {"AMI" : "ami-0fbd680de4821a361"},
            "ap-southeast-1" : {"AMI" : "ami-009e368b9411ba909"},
            "ap-southeast-2" : {"AMI" : "ami-04eaeca8a0129c72d"},
            "eu-central-1" : {"AMI" : "ami-0f6ae0c1440880fae"},
            "us-east-1" : {"AMI" : "ami-08cdb240fc2f1b628"},
            "us-east-2" : {"AMI" : "ami-043ded16d331257c7"},
            "us-west-1" : {"AMI" : "ami-0fbf0d00e39f7a864"},
            "us-west-2" : {"AMI" : "ami-0e08ff376531d1647"}
        },
        "Ubuntu1804": {
            "eu-north-1": { "AMI": "ami-5e9c1520" },
            "ap-south-1": { "AMI": "ami-007d5db58754fa284" },
            "eu-west-3": { "AMI": "ami-03bca18cb3dc173c9" },
            "eu-west-2": { "AMI": "ami-07dc734dc14746eab" },
            "eu-west-1": { "AMI": "ami-08d658f84a6d84a80" },
            "ap-northeast-2": { "AMI": "ami-078e96948945fc2c9" },
            "ap-northeast-1": { "AMI": "ami-0eb48a19a8d81e20b" },
            "sa-east-1": { "AMI": "ami-09f4cd7c0b533b081" },
            "ca-central-1": { "AMI": "ami-01b60a3259250381b" },
            "ap-southeast-1": { "AMI": "ami-0dad20bd1b9c8c004" },
            "ap-southeast-2": { "AMI": "ami-0b76c3b150c6b1423" },
            "eu-central-1": { "AMI": "ami-090f10efc254eaf55" },
            "us-east-1": { "AMI": "ami-0a313d6098716f372" },
            "us-east-2": { "AMI": "ami-0c55b159cbfafe1f0" },
            "us-west-1": { "AMI": "ami-06397100adf427136" },
            "us-west-2": { "AMI": "ami-005bdb005fb00e791" }
        },
        "AWSLinux2": {
            "eu-north-1": { "AMI": "ami-3f36be41" },
            "ap-south-1": { "AMI": "ami-0d2692b6acea72ee6" },
            "eu-west-3": { "AMI": "ami-0adcddd3324248c4c" },
            "eu-west-2": { "AMI": "ami-0d8e27447ec2c8410" },
            "eu-west-1": { "AMI": "ami-0bbc25e23a7640b9b" },
            "ap-northeast-2": { "AMI": "ami-095ca789e0549777d" },
            "ap-northeast-1": { "AMI": "ami-0c3fd0f5d33134a76" },
            "sa-east-1": { "AMI": "ami-058943e7d9b9cabfb" },
            "ca-central-1": { "AMI": "ami-0d4ae09ec9361d8ac" },
            "ap-southeast-1": { "AMI": "ami-01f7527546b557442" },
            "ap-southeast-2": { "AMI": "ami-0dc96254d5535925f" },
            "eu-central-1": { "AMI": "ami-0cc293023f983ed53" },
            "us-east-1": { "AMI": "ami-0b898040803850657" },
            "us-east-2": { "AMI": "ami-0d8f6eb4f641ef691" },
            "us-west-1": { "AMI": "ami-056ee704806822732" },
            "us-west-2": { "AMI": "ami-082b5a644766e0e6f" }
        }
    },
    "Outputs": {
        "VPC": {
            "Description": "A reference to the created VPC",
            "Value": {
                "Ref": "VPC"
            }
        },
        "BIGIP": {
            "Condition": "False",
            "Description": "BIGIP Mgmt Address",
            "Value":
                {
                    "Fn::Join": [
                        "",
                        [
                            "https://",
                            { "Fn::GetAtt" : [ "EC2BigIPPAYG" , "PublicDnsName" ] }
                        ]
                    ]
                }
        },
        "JumpHost": {
            "Condition": "False",
            "Description": "Jump Host FQDN",
            "Value": { "Fn::GetAtt" : [ "EC2JumpHost" , "PublicDnsName" ] }
        },
        "DeleteSyntax": {
            "Description": "Use this command on the JumpHost to deprovision your stack",
            "Value":"/tmp/deprovision_stack.sh"
        }
    }
}
